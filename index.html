<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Tic-Tac-Toe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            touch-action: manipulation; /* Mobile par double tap zoom ko rokne ke liye */
        }
        .cell {
            transition: all 0.2s ease;
        }
        .cell:hover {
            background-color: #374151; /* Darker hover for cells */
        }
        .btn {
            transition: all 0.2s ease;
        }
        #game-board.disabled {
            pointer-events: none;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md mx-auto">

        <!-- Initial Screen: Create or Join Game -->
        <div id="menu-screen" class="text-center space-y-6">
            <h1 class="text-5xl font-bold text-cyan-400">Tic-Tac-Toe</h1>
            <p class="text-gray-400">Doston ke saath online khelein!</p>
            <div>
                <button id="create-game-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg text-lg btn">
                    Naya Game Banayein
                </button>
            </div>
            <div class="flex items-center space-x-2">
                <hr class="flex-grow border-gray-600">
                <span class="text-gray-500">YA</span>
                <hr class="flex-grow border-gray-600">
            </div>
            <div class="space-y-3">
                <input type="text" id="game-id-input" placeholder="Dost ka Game ID daalein" class="w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-center focus:outline-none focus:border-cyan-500">
                <button id="join-game-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg btn">
                    Game Join Karein
                </button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden text-center">
            <div class="mb-4">
                <p class="text-gray-400">Game ID (dost ko bhejein):</p>
                <div class="flex justify-center items-center gap-2 mt-2">
                    <span id="game-id-display" class="text-2xl font-mono bg-gray-800 p-2 rounded-lg"></span>
                    <button id="copy-id-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg btn">Copy</button>
                </div>
            </div>
            
            <p id="status-text" class="text-xl h-14 my-4 flex items-center justify-center text-cyan-400"></p>

            <div id="game-board" class="grid grid-cols-3 gap-3 w-full aspect-square max-w-sm mx-auto bg-gray-800 p-3 rounded-lg shadow-lg">
                <!-- Cells will be generated by JS -->
            </div>

             <button id="new-game-btn" class="hidden w-full mt-6 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg text-lg btn">
                Naya Game Khele?
            </button>

        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENTS ---
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');
        const gameIdDisplay = document.getElementById('game-id-display');
        const copyIdBtn = document.getElementById('copy-id-btn');
        const statusText = document.getElementById('status-text');
        const gameBoard = document.getElementById('game-board');
        const newGameBtn = document.getElementById('new-game-btn');
        
        // --- FIREBASE SETUP ---
        let db, auth;
        let currentUser = null;
        let gameUnsubscribe = null; // To stop listening to game updates

        // Use pre-configured firebase config and auth token if available
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIza...", authDomain: "...", projectId: "..." };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
            } else {
                try {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch(e) {
                    console.error("Authentication Error: ", e);
                    statusText.textContent = "Authentication failed. Please refresh.";
                }
            }
        });


        // --- GAME LOGIC ---
        let playerSymbol = '';
        let currentGameId = '';

        // Function to create game board cells
        function createBoard() {
            gameBoard.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell', 'w-full', 'h-full', 'flex', 'items-center', 'justify-center', 'text-6xl', 'font-bold', 'bg-gray-700', 'rounded-lg', 'cursor-pointer');
                cell.dataset.index = i;
                cell.addEventListener('click', handleCellClick);
                gameBoard.appendChild(cell);
            }
        }

        async function createNewGame() {
            if (!currentUser) { alert("Pehle authenticate ho raha hai..."); return; }
            
            const gameId = Math.random().toString(36).substr(2, 6).toUpperCase();
            currentGameId = gameId;
            playerSymbol = 'X';

            const gameRef = doc(db, `/artifacts/${appId}/public/data/tic-tac-toe-games`, gameId);
            
            try {
                await setDoc(gameRef, {
                    board: Array(9).fill(''),
                    players: [currentUser.uid],
                    currentPlayerIndex: 0,
                    status: 'waiting', // 'waiting', 'playing', 'finished'
                    winner: null, // 'X', 'O', 'draw'
                    createdAt: new Date()
                });
                
                showGameScreen(gameId);
                listenToGameUpdates(gameId);
            } catch (error) {
                console.error("Game banane mein error: ", error);
                alert("Game banane mein error aaya. Please dobara try karein.");
            }
        }

        async function joinGame() {
            if (!currentUser) { alert("Pehle authenticate ho raha hai..."); return; }

            const gameId = gameIdInput.value.trim().toUpperCase();
            if (!gameId) { alert("Please Game ID daalein."); return; }

            const gameRef = doc(db, `/artifacts/${appId}/public/data/tic-tac-toe-games`, gameId);
            const gameSnap = await getDoc(gameRef);

            if (!gameSnap.exists()) {
                alert("Game ID galat hai!");
                return;
            }

            const gameData = gameSnap.data();

            if (gameData.players.length >= 2 && !gameData.players.includes(currentUser.uid)) {
                alert("Game pehle se full hai!");
                return;
            }

            currentGameId = gameId;
            
            if(!gameData.players.includes(currentUser.uid)) {
                 await updateDoc(gameRef, {
                    players: [...gameData.players, currentUser.uid],
                    status: 'playing'
                });
                 playerSymbol = 'O';
            } else {
                 playerSymbol = gameData.players[0] === currentUser.uid ? 'X' : 'O';
            }

            showGameScreen(gameId);
            listenToGameUpdates(gameId);
        }

        function listenToGameUpdates(gameId) {
            if (gameUnsubscribe) gameUnsubscribe(); // Stop listening to old game
            
            const gameRef = doc(db, `/artifacts/${appId}/public/data/tic-tac-toe-games`, gameId);
            gameUnsubscribe = onSnapshot(gameRef, (doc) => {
                const gameData = doc.data();
                if (gameData) {
                    updateUI(gameData);
                }
            });
        }

        function updateUI(gameData) {
            // Update board
            const cells = gameBoard.querySelectorAll('.cell');
            gameData.board.forEach((symbol, index) => {
                cells[index].textContent = symbol;
                if(symbol === 'X') cells[index].classList.add('text-red-400');
                if(symbol === 'O') cells[index].classList.add('text-blue-400');
            });

            const myTurn = gameData.players[gameData.currentPlayerIndex] === currentUser.uid;

            // Update status text and board state
            if (gameData.status === 'waiting') {
                statusText.textContent = "Dost ka intezar hai...";
                gameBoard.classList.add('disabled');
            } else if (gameData.status === 'playing') {
                 if (myTurn) {
                    statusText.innerHTML = `Aapki chaal hai <span class="font-bold text-2xl ${playerSymbol === 'X' ? 'text-red-400' : 'text-blue-400'}">(${playerSymbol})</span>`;
                    gameBoard.classList.remove('disabled');
                } else {
                    statusText.textContent = "Dost ki chaal hai...";
                    gameBoard.classList.add('disabled');
                }
            } else if (gameData.status === 'finished') {
                gameBoard.classList.add('disabled');
                newGameBtn.classList.remove('hidden');
                if (gameData.winner === 'draw') {
                    statusText.textContent = "Game Draw!";
                } else {
                    const amIWinner = gameData.players.indexOf(currentUser.uid) === (gameData.winner === 'X' ? 0 : 1);
                    statusText.textContent = amIWinner ? "Aap Jeet Gaye! ðŸŽ‰" : "Aap Haar Gaye ðŸ˜ž";
                }
            }
        }
        
        async function handleCellClick(event) {
            const cellIndex = parseInt(event.target.dataset.index);
            const gameRef = doc(db, `/artifacts/${appId}/public/data/tic-tac-toe-games`, currentGameId);
            const gameSnap = await getDoc(gameRef);
            const gameData = gameSnap.data();

            // Check if move is valid
            if (gameData.board[cellIndex] !== '' || gameData.status !== 'playing' || gameData.players[gameData.currentPlayerIndex] !== currentUser.uid) {
                return;
            }

            // Update board
            const newBoard = [...gameData.board];
            newBoard[cellIndex] = playerSymbol;
            
            // Check for winner
            const winnerInfo = checkWinner(newBoard);
            
            const updatePayload = {
                board: newBoard,
                currentPlayerIndex: (gameData.currentPlayerIndex + 1) % 2
            };

            if (winnerInfo.winner) {
                updatePayload.status = 'finished';
                updatePayload.winner = winnerInfo.winner;
            }

            await updateDoc(gameRef, updatePayload);
        }
        
        function checkWinner(board) {
            const winningCombos = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6]  // diagonals
            ];

            for (const combo of winningCombos) {
                const [a, b, c] = combo;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return { winner: board[a] };
                }
            }

            if (board.every(cell => cell !== '')) {
                return { winner: 'draw' };
            }

            return { winner: null };
        }

        // --- UI FLOW ---
        function showGameScreen(gameId) {
            createBoard();
            gameIdDisplay.textContent = gameId;
            menuScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
        }

        function resetToMenu() {
            if (gameUnsubscribe) gameUnsubscribe();
            menuScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            gameIdInput.value = '';
            newGameBtn.classList.add('hidden');
        }

        // --- EVENT LISTENERS ---
        createGameBtn.addEventListener('click', createNewGame);
        joinGameBtn.addEventListener('click', joinGame);
        newGameBtn.addEventListener('click', resetToMenu);
        copyIdBtn.addEventListener('click', () => {
            // Using document.execCommand for wider compatibility in iframes
            const tempInput = document.createElement('textarea');
            tempInput.value = currentGameId;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                copyIdBtn.textContent = 'Copied!';
                setTimeout(() => { copyIdBtn.textContent = 'Copy'; }, 2000);
            } catch (err) {
                console.error('Copy failed', err);
                alert('ID copy nahi ho paya. Please manually copy karein.');
            }
            document.body.removeChild(tempInput);
        });

    </script>
</body>
</html>
